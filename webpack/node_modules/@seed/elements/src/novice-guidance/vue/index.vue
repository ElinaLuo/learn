<template>
  <div
    :class="classes.outer"
    v-if="dataShow"
    @transitionend="handleTransitionEnd"
    ref="outer"
  >
    <div :class="classes.arrow" :style="'left: ' + arrowPosition + '%;'"></div>
    <div :class="classes.wrap">
      <div :class="classes.text">
        <slot></slot>
      </div>
      <span :class="classes.close" @click="handleClose"></span>
    </div>
  </div>
</template>

<script>
import '../style/index.less';
import { prefixCls } from '@seed/ui-base';

export default {
  name: 'novice-guidance',
  props: {
    type: {
      type: String,
      default: 'rectangle',
      validator(value) {
        return ['rectangle', 'circle'].includes(value);
      },
    },
    show: {
      type: Boolean,
      default: false,
    },
    autoHideTimeout: {
      type: Number,
      default: 5000,
    },
    arrowPosition: {
      type: Number,
      default: 50,
    },
    flipArrow: {
      type: Boolean,
      default: false,
    },
  },
  data() {
    return {
      dataShow: this.show,
      visible: false,
    };
  },
  mounted() {
    const { autoHideTimeout, show } = this;
    if (show && autoHideTimeout) {
      this.setAutoHide();
    }
    if (show) {
      this.startToShow();
    }
  },
  beforeDestroy() {
    this.clearAutoHideTimeout();
  },
  watch: {
    show(newVal, oldVal) {
      if (newVal === oldVal) {
        return;
      }
      if (newVal) {
        this.dataShow = newVal;
        this.startToShow();
      } else {
        this.visible = false;
      }
    },
  },
  computed: {
    classes() {
      return {
        wrap: prefixCls('novice-guidance', 'wrap'),
        arrow: [
          prefixCls('novice-guidance', 'arrow'),
          this.flipArrow && prefixCls('novice-guidance', 'arrow', 'flipped'),
        ],
        close: prefixCls('novice-guidance', 'close'),
        outer: [
          prefixCls('novice-guidance'),
          prefixCls(
            'novice-guidance',
            this.type === 'circle' ? 'circle' : 'rectangle',
          ),
          this.visible && prefixCls('novice-guidance', 'fadein'),
        ],
        text: prefixCls('novice-guidance', 'text'),
      };
    },
  },
  methods: {
    handleClose() {
      this.visible = false;
    },
    handleTransitionEnd() {
      const { show, autoHideTimeout } = this;
      if (show) {
        if (autoHideTimeout) {
          this.setAutoHide();
        }
        this.$emit('show');
      } else {
        this.dataShow = false;
        this.$emit('hide');
      }
    },
    setAutoHide() {
      const { autoHideTimeout } = this;
      this.timeout = setTimeout(() => {
        this.dataShow = false;
        this.clearAutoHideTimeout();
        this.$emit('hide');
      }, autoHideTimeout);
    },
    clearAutoHideTimeout() {
      if (this.timeout) {
        clearTimeout(this.timeout);
        this.timeout = null;
      }
    },
    startToShow() {
      this.$nextTick(() => {
        window.getComputedStyle(this.$refs.outer).opacity; // 解决 vue 不触发 transitionend 的问题，是不是 dom 画上去的时候就已经有 fadein 样式类了？
        let tid = setTimeout(() => {
          clearTimeout(tid);
          tid = null;
          this.visible = true;
        }, 1);
      });
    },
  },
};
</script>
